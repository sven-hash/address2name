name: Validate known-walletsv2.json

on:
  workflow_dispatch: 
  push:
    branches:
      - main
      - master
      - develop
    paths:
      - 'known-walletsv2.json'
  pull_request:
    branches:
      - main
      - master
      - develop
    paths:
      - 'known-walletsv2.json'

jobs:
  validate-json:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate JSON syntax
        run: |
          echo "Validating known-walletsv2.json syntax..."
          
          # Try to parse JSON and show detailed error with line number
          ERROR=$(jq empty known-walletsv2.json 2>&1)
          
          if [ $? -ne 0 ]; then
            echo "‚ùå Invalid JSON syntax in known-walletsv2.json"
            echo ""
            echo "Error details:"
            echo "$ERROR"
            echo ""
            
            # Extract line number if available
            LINE=$(echo "$ERROR" | grep -oP 'line \K\d+' || echo "$ERROR" | grep -oP 'at line \K\d+')
            if [ ! -z "$LINE" ]; then
              echo "üìç Error at line $LINE:"
              echo "---"
              sed -n "$((LINE-2)),$((LINE+2))p" known-walletsv2.json | nl -ba -v $((LINE-2))
              echo "---"
            fi
            
            exit 1
          else
            echo "‚úÖ Valid JSON syntax"
          fi

      - name: Validate JSON structure
        run: |
          echo "Validating known-walletsv2.json structure..."
          
          # Check if root is an object
          if ! jq -e 'type == "object"' known-walletsv2.json > /dev/null; then
            echo "‚ùå Root must be an object (not an array or primitive)"
            echo "üìç Line 1: File should start with '{' and end with '}'"
            exit 1
          fi
          
          # Check if file is not empty
          if [ $(jq 'length' known-walletsv2.json) -eq 0 ]; then
            echo "‚ùå File cannot be empty - must contain at least one wallet entry"
            exit 1
          fi
          
          echo "‚úÖ Basic structure is valid"

      - name: Validate required fields
        run: |
          echo "Validating that all entries have required fields..."
          
          # Create a detailed report with line numbers
          jq -r '
            to_entries | 
            map(
              select(
                (.value | has("type") and has("name") and has("state") and has("exchangename")) | not
              ) | 
              {
                key: .key,
                missing: [
                  (if (.value | has("type")) then empty else "type" end),
                  (if (.value | has("name")) then empty else "name" end),
                  (if (.value | has("state")) then empty else "state" end),
                  (if (.value | has("exchangename")) then empty else "exchangename" end)
                ]
              }
            ) |
            if length > 0 then
              "‚ùå The following wallet keys are missing required fields:\n" +
              (map("  - Key: \(.key)\n    Missing fields: \(.missing | join(", "))") | join("\n"))
            else
              empty
            end
          ' known-walletsv2.json > /tmp/validation_errors.txt
          
          if [ -s /tmp/validation_errors.txt ]; then
            cat /tmp/validation_errors.txt
            echo ""
            echo "Required fields: type, name, state, exchangename"
            
            # Find and show the problematic entries in the file
            MISSING_KEYS=$(jq -r '
              to_entries | 
              map(
                select(
                  (.value | has("type") and has("name") and has("state") and has("exchangename")) | not
                ) | 
                .key
              ) | 
              .[]
            ' known-walletsv2.json)
            
            for KEY in $MISSING_KEYS; do
              echo ""
              echo "üìç Entry with key: $KEY"
              LINE=$(grep -n "\"$KEY\"" known-walletsv2.json | cut -d: -f1 | head -1)
              if [ ! -z "$LINE" ]; then
                echo "   Found at line $LINE:"
                echo "   ---"
                sed -n "$LINE,$((LINE+6))p" known-walletsv2.json | nl -ba -v $LINE
                echo "   ---"
              fi
            done
            
            exit 1
          else
            echo "‚úÖ All entries have required fields"
          fi

      - name: Validate wallet keys exist
        run: |
          echo "Validating that all keys are non-empty..."
          
          # Check for empty keys
          EMPTY_KEYS=$(jq -r 'keys[] | select(. == "")' known-walletsv2.json)
          
          if [ ! -z "$EMPTY_KEYS" ]; then
            echo "‚ùå Found empty wallet keys"
            echo "üìç Search for '\"\":' in the file"
            LINE=$(grep -n '""' known-walletsv2.json | head -1 | cut -d: -f1)
            if [ ! -z "$LINE" ]; then
              echo "Found at approximately line $LINE:"
              sed -n "$((LINE-1)),$((LINE+1))p" known-walletsv2.json | nl -ba -v $((LINE-1))
            fi
            exit 1
          fi
          
          # Count total entries
          TOTAL=$(jq 'length' known-walletsv2.json)
          echo "‚úÖ Found $TOTAL wallet entries with valid keys"

      - name: Validate state values
        run: |
          echo "Validating state values..."
          
          # Create detailed report with line numbers
          jq -r '
            to_entries | 
            map(
              select(.value.state != "verified" and .value.state != "pending" and .value.state != "rejected" and .value.state != "") | 
              {key: .key, state: .value.state}
            ) |
            if length > 0 then
              map("  - Key: \(.key)\n    Invalid state: \"\(.state)\"") | join("\n")
            else
              empty
            end
          ' known-walletsv2.json > /tmp/state_errors.txt
          
          if [ -s /tmp/state_errors.txt ]; then
            echo "‚ùå Invalid state values found (must be 'verified', 'pending', 'rejected', or empty string):"
            echo ""
            cat /tmp/state_errors.txt
            echo ""
            
            # Show location in file
            INVALID_KEYS=$(jq -r '
              to_entries | 
              map(
                select(.value.state != "verified" and .value.state != "pending" and .value.state != "rejected" and .value.state != "") | 
                .key
              ) | 
              .[]
            ' known-walletsv2.json)
            
            for KEY in $INVALID_KEYS; do
              echo ""
              echo "üìç Entry with key: $KEY"
              LINE=$(grep -n "\"$KEY\"" known-walletsv2.json | cut -d: -f1 | head -1)
              STATE_LINE=$(sed -n "$LINE,$((LINE+10))p" known-walletsv2.json | grep -n '"state"' | head -1 | cut -d: -f1)
              ACTUAL_LINE=$((LINE + STATE_LINE - 1))
              if [ ! -z "$ACTUAL_LINE" ]; then
                echo "   State field at line $ACTUAL_LINE:"
                echo "   ---"
                sed -n "$((ACTUAL_LINE-1)),$((ACTUAL_LINE+1))p" known-walletsv2.json | nl -ba -v $((ACTUAL_LINE-1))
                echo "   ---"
              fi
            done
            
            exit 1
          else
            echo "‚úÖ All state values are valid"
          fi

      - name: Validate field types
        run: |
          echo "Validating field types..."
          
          # Check that all field values are strings
          jq -r '
            to_entries | 
            map(
              {
                key: .key,
                type_invalid: (if (.value.type | type != "string") then "type is \(.value.type | type)" else empty end),
                name_invalid: (if (.value.name | type != "string") then "name is \(.value.name | type)" else empty end),
                state_invalid: (if (.value.state | type != "string") then "state is \(.value.state | type)" else empty end),
                exchangename_invalid: (if (.value.exchangename | type != "string") then "exchangename is \(.value.exchangename | type)" else empty end)
              } |
              select(.type_invalid or .name_invalid or .state_invalid or .exchangename_invalid)
            ) |
            if length > 0 then
              map("  - Key: \(.key)\n    Issues: \([.type_invalid, .name_invalid, .state_invalid, .exchangename_invalid] | map(select(. != null)) | join(", "))") | join("\n")
            else
              empty
            end
          ' known-walletsv2.json > /tmp/type_errors.txt
          
          if [ -s /tmp/type_errors.txt ]; then
            echo "‚ùå The following wallet keys have non-string field values:"
            echo ""
            cat /tmp/type_errors.txt
            echo ""
            echo "All fields (type, name, state, exchangename) must be strings"
            
            # Show location in file
            INVALID_KEYS=$(jq -r '
              to_entries | 
              map(
                select(
                  (.value.type | type != "string") or
                  (.value.name | type != "string") or
                  (.value.state | type != "string") or
                  (.value.exchangename | type != "string")
                ) | 
                .key
              ) | 
              .[]
            ' known-walletsv2.json)
            
            for KEY in $INVALID_KEYS; do
              echo ""
              echo "üìç Entry with key: $KEY"
              LINE=$(grep -n "\"$KEY\"" known-walletsv2.json | cut -d: -f1 | head -1)
              if [ ! -z "$LINE" ]; then
                echo "   Found at line $LINE:"
                echo "   ---"
                sed -n "$LINE,$((LINE+6))p" known-walletsv2.json | nl -ba -v $LINE
                echo "   ---"
              fi
            done
            
            exit 1
          else
            echo "‚úÖ All field types are valid (strings)"
          fi

      - name: Check for duplicate keys
        run: |
          echo "Checking for duplicate wallet keys..."
          
          # Extract all keys and check for duplicates
          DUPLICATES=$(jq -r 'keys[]' known-walletsv2.json | sort | uniq -d)
          
          if [ ! -z "$DUPLICATES" ]; then
            echo "‚ùå Found duplicate wallet keys:"
            echo "$DUPLICATES"
            
            for KEY in $DUPLICATES; do
              echo ""
              echo "üìç Duplicate key: $KEY"
              echo "   Found at lines:"
              grep -n "\"$KEY\"" known-walletsv2.json
            done
            
            exit 1
          else
            echo "‚úÖ No duplicate keys found"
          fi

      - name: Display summary
        if: success()
        run: |
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "‚úÖ All validations passed!"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          jq -r '
            "Total wallets: \(length)",
            "Verified: \([.[] | select(.state == "verified")] | length)",
            "Pending: \([.[] | select(.state == "pending")] | length)",
            "Rejected: \([.[] | select(.state == "rejected")] | length)"
          ' known-walletsv2.json

      - name: Comment on PR
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let body = '';
            
            try {
              const data = JSON.parse(fs.readFileSync('known-walletsv2.json', 'utf8'));
              const total = Object.keys(data).length;
              const verified = Object.values(data).filter(w => w.state === 'verified').length;
              const pending = Object.values(data).filter(w => w.state === 'pending').length;
              const rejected = Object.values(data).filter(w => w.state === 'rejected').length;
              
              if ('${{ job.status }}' === 'success') {
                body = `‚úÖ **JSON validation passed!**\n\n` +
                       `üìä **Summary:**\n` +
                       `- Total wallets: ${total}\n` +
                       `- Verified: ${verified}\n` +
                       `- Pending: ${pending}\n` +
                       `- Rejected: ${rejected}`;
              } else {
                body = `‚ùå **JSON validation failed!**\n\n` +
                       `Please check the [workflow logs](${context.payload.repository.html_url}/actions/runs/${context.runId}) for detailed error messages including line numbers.`;
              }
            } catch (error) {
              body = `‚ùå **JSON validation failed!**\n\n` +
                     `The file contains syntax errors. Please check the [workflow logs](${context.payload.repository.html_url}/actions/runs/${context.runId}) for details.`;
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
