name: Validate known-walletsv2.json

on:
  workflow_dispatch: 
  push:
    branches:
      - main
      - master
      - develop
    paths:
      - 'known-walletsv2.json'
  pull_request:
    branches:
      - main
      - master
      - develop
    paths:
      - 'known-walletsv2.json'

jobs:
  validate-json:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate JSON syntax
        run: |
          echo "Validating known-walletsv2.json syntax..."
          
          # Disable exit on error temporarily
          set +e
          ERROR=$(jq empty known-walletsv2.json 2>&1)
          EXIT_CODE=$?
          set -e
          
          if [ $EXIT_CODE -ne 0 ]; then
            echo "‚ùå Invalid JSON syntax in known-walletsv2.json"
            echo ""
            echo "Error details:"
            echo "$ERROR"
            echo ""
            
            # Extract line number if available
            LINE=$(echo "$ERROR" | grep -oP 'line \K\d+' || echo "$ERROR" | grep -oP 'at line \K\d+' || echo "")
            if [ ! -z "$LINE" ]; then
              echo "üìç Error at line $LINE:"
              echo "---"
              sed -n "$((LINE-2)),$((LINE+2))p" known-walletsv2.json 2>/dev/null | nl -ba -v $((LINE-2)) || echo "Could not display context"
              echo "---"
            fi
            
            exit 1
          else
            echo "‚úÖ Valid JSON syntax"
          fi

      - name: Validate JSON structure
        run: |
          echo "Validating known-walletsv2.json structure..."
          
          # Check if root is an object
          if ! jq -e 'type == "object"' known-walletsv2.json > /dev/null 2>&1; then
            echo "‚ùå Root must be an object (not an array or primitive)"
            echo "üìç Line 1: File should start with '{' and end with '}'"
            exit 1
          fi
          
          # Check if file is not empty
          COUNT=$(jq 'length' known-walletsv2.json)
          if [ "$COUNT" -eq 0 ]; then
            echo "‚ùå File cannot be empty - must contain at least one wallet entry"
            exit 1
          fi
          
          echo "‚úÖ Basic structure is valid (found $COUNT entries)"

      - name: Validate required fields
        run: |
          echo "Validating that all entries have required fields..."
          
          set +e
          RESULT=$(jq -r '
            to_entries | 
            map(
              select(
                (.value | has("type") and has("name") and has("state") and has("exchangename")) | not
              ) | 
              {
                key: .key,
                missing: [
                  (if (.value | has("type")) then empty else "type" end),
                  (if (.value | has("name")) then empty else "name" end),
                  (if (.value | has("state")) then empty else "state" end),
                  (if (.value | has("exchangename")) then empty else "exchangename" end)
                ]
              }
            ) |
            if length > 0 then
              (map("‚ùå Key: \(.key)\n   Missing fields: \(.missing | join(", "))") | join("\n\n"))
            else
              empty
            end
          ' known-walletsv2.json)
          set -e
          
          if [ ! -z "$RESULT" ]; then
            echo "‚ùå The following wallet keys are missing required fields:"
            echo ""
            echo "$RESULT"
            echo ""
            echo "Required fields: type, name, state, exchangename"
            exit 1
          else
            echo "‚úÖ All entries have required fields"
          fi

      - name: Validate wallet keys
        run: |
          echo "Validating wallet keys..."
          
          # Check for empty keys
          set +e
          EMPTY_COUNT=$(jq -r 'keys[] | select(. == "")' known-walletsv2.json | wc -l)
          set -e
          
          if [ "$EMPTY_COUNT" -gt 0 ]; then
            echo "‚ùå Found $EMPTY_COUNT empty wallet key(s)"
            echo "üìç Search for '\"\":' in the file"
            grep -n '""' known-walletsv2.json | head -5
            exit 1
          fi
          
          echo "‚úÖ All wallet keys are non-empty"

      - name: Validate state values
        run: |
          echo "Validating state values..."
          
          set +e
          INVALID_STATES=$(jq -r '
            to_entries | 
            map(
              select(.value.state != "verified" and .value.state != "pending" and .value.state != "rejected" and .value.state != "") | 
              "‚ùå Key: \(.key)\n   Invalid state: \"\(.value.state)\""
            ) |
            if length > 0 then
              join("\n\n")
            else
              empty
            end
          ' known-walletsv2.json)
          set -e
          
          if [ ! -z "$INVALID_STATES" ]; then
            echo "‚ùå Invalid state values found:"
            echo ""
            echo "$INVALID_STATES"
            echo ""
            echo "Valid states: 'verified', 'pending', 'rejected', or empty string ''"
            exit 1
          else
            echo "‚úÖ All state values are valid"
          fi

      - name: Validate field types
        run: |
          echo "Validating field types..."
          
          set +e
          TYPE_ERRORS=$(jq -r '
            to_entries | 
            map(
              {
                key: .key,
                errors: [
                  (if (.value.type | type != "string") then "type is \(.value.type | type), not string" else empty end),
                  (if (.value.name | type != "string") then "name is \(.value.name | type), not string" else empty end),
                  (if (.value.state | type != "string") then "state is \(.value.state | type), not string" else empty end),
                  (if (.value.exchangename | type != "string") then "exchangename is \(.value.exchangename | type), not string" else empty end)
                ] | map(select(length > 0))
              } |
              select(.errors | length > 0) |
              "‚ùå Key: \(.key)\n   Issues: \(.errors | join(", "))"
            ) |
            if length > 0 then
              join("\n\n")
            else
              empty
            end
          ' known-walletsv2.json)
          set -e
          
          if [ ! -z "$TYPE_ERRORS" ]; then
            echo "‚ùå Field type errors found:"
            echo ""
            echo "$TYPE_ERRORS"
            echo ""
            echo "All fields must be strings"
            exit 1
          else
            echo "‚úÖ All field types are valid"
          fi

      - name: Check for duplicate keys
        run: |
          echo "Checking for duplicate keys..."
          
          # JSON doesn't allow duplicate keys, but we can check the raw file
          set +e
          DUPLICATES=$(grep -o '"[^"]*"[[:space:]]*:' known-walletsv2.json | sort | uniq -d)
          set -e
          
          if [ ! -z "$DUPLICATES" ]; then
            echo "‚ùå Warning: Possible duplicate keys found:"
            echo "$DUPLICATES"
            echo ""
            echo "Note: JSON will only keep the last occurrence of duplicate keys"
          else
            echo "‚úÖ No obvious duplicate keys found"
          fi

      - name: Display validation summary
        if: success()
        run: |
          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "‚úÖ All validations passed!"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          
          TOTAL=$(jq 'length' known-walletsv2.json)
          VERIFIED=$(jq '[.[] | select(.state == "verified")] | length' known-walletsv2.json)
          PENDING=$(jq '[.[] | select(.state == "pending")] | length' known-walletsv2.json)
          REJECTED=$(jq '[.[] | select(.state == "rejected")] | length' known-walletsv2.json)
          EMPTY_STATE=$(jq '[.[] | select(.state == "")] | length' known-walletsv2.json)
          
          echo "üìä Summary:"
          echo "  Total wallets: $TOTAL"
          echo "  Verified: $VERIFIED"
          echo "  Pending: $PENDING"
          echo "  Rejected: $REJECTED"
          echo "  Empty state: $EMPTY_STATE"

      - name: Comment on PR
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let body = '';
            
            try {
              const data = JSON.parse(fs.readFileSync('known-walletsv2.json', 'utf8'));
              const total = Object.keys(data).length;
              const verified = Object.values(data).filter(w => w.state === 'verified').length;
              const pending = Object.values(data).filter(w => w.state === 'pending').length;
              const rejected = Object.values(data).filter(w => w.state === 'rejected').length;
              const emptyState = Object.values(data).filter(w => w.state === '').length;
              
              if ('${{ job.status }}' === 'success') {
                body = `‚úÖ **JSON validation passed!**\n\n` +
                       `üìä **Summary:**\n` +
                       `- Total wallets: ${total}\n` +
                       `- Verified: ${verified}\n` +
                       `- Pending: ${pending}\n` +
                       `- Rejected: ${rejected}\n` +
                       `- Empty state: ${emptyState}`;
              } else {
                body = `‚ùå **JSON validation failed!**\n\n` +
                       `Please check the [workflow logs](${context.payload.repository.html_url}/actions/runs/${context.runId}) for detailed error messages.`;
              }
            } catch (error) {
              body = `‚ùå **JSON validation failed!**\n\n` +
                     `Error: ${error.message}\n\n` +
                     `Please check the [workflow logs](${context.payload.repository.html_url}/actions/runs/${context.runId}) for details.`;
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
